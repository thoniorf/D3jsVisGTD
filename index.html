<!DOCTYPE html>
<html>

<head>
  <title>GTD - BD18</title>
  <meta charset="utf-8">
  <script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script>
  <script src="lib/d3.min.js"></script>
  <style type="text/css">
    body {
      width: 100vw;
      margin: 25px auto;
      font-family: "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
    }

    rect {
      fill: steelblue;
      fill-opacity: 0.8;
    }

    rect:hover {
      fill-opacity: 1;
    }

    path {
      fill-opacity: 0.8;
    }

    .selected,
    path:hover {
      fill-opacity: 1;
    }

    .axis {
      font-size: smaller;
    }

    main {
      display: flex;
      flex-wrap: wrap;
    }
  </style>
</head>

<body>
  <article>
    <header>
      <h1>Global Terrorism Database Analysis</h1>
    </header>
    <p>If there's a microphone anywhere near you, assume it's hot and
      sending whatever you're saying to the world. Seriously.</p>
    <p>...</p>
    <section>
      <h1>Data overview</h1>
      <p>I am a paragraph without any real meaning, maybe next time put just some emoji, little bastard.</p>
      <p><label for="weapfilter">Weapon Filter </label><select id="weapfilter"></select></p>
      <svg id="overview"></svg>
      <svg id="weapontype"></svg>
      <svg id="timeline"></svg>
      <svg id="pie"></svg>
    </section>
  </article>
  <script type="text/javascript">

    const state = {
      data: [],
      weaptype1: null
      // TODO store selected survived state
    };

    d3.tsv('gtd1417.csv').then((parsed) => {
      state.data = parsed.map((row) => {
        row.country = parseFloat(row.country);
        return row;
      });
      fillWeaponFilter('#weapfilter');
      updateApp();
    });

    const attacksBarChar = createOverviewChart('#overview');
    console.log(attacksBarChar);
    function updateApp() {
      console.log("Data source fetched");
      var data = filterData();
      attacksBarChar(data);
    }
    function filterData() {
      if (!state.weaptype1) return state.data;
      const filtered_data = state.data
        .filter((d) => {
          return d.weaptype1_txt === state.weaptype1
        });
      return filtered_data;
    }
    function fillWeaponFilter(element_id) {
      var nestedStateData = d3.nest()
        .key((d) => d.weaptype1_txt)
        .entries(state.data);
      d3.select(element_id).selectAll('option')
        .data(nestedStateData, (d) => d.key)
        .enter()
        .append('option')
        .attr('value', (d) => d.key)
        .text((d) => d.key);
    }

    function createOverviewChart(element_id) {
      const margin = { top: 10, bottom: 120, left: 80, right: 10 };
      const width = 500;
      const height = 300;

      var svg = d3.select(element_id)
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom);

      svg.append('text')
        .attr('x', width / 2 + margin.left)
        .attr('y', margin.top * 1.5)
        .attr('text-anchor', 'middle')
        .text('Top countries by attacks number')
      svg.append('text')
        .attr('x', -height / 2)
        .attr('y', margin.right * 2)
        .attr('text-anchor', 'middle')
        .attr('transform', 'rotate(-90)')
        .text('Attacks number')

      var chart = svg.append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);

      var yScale = d3.scaleLinear().range([height, 0]);
      var xScale = d3.scaleBand()
        .range([0, width])
        .padding(0.02);

      var yAxis = d3.axisLeft(yScale);
      var xAxis = d3.axisBottom(xScale);

      var yAxisNode = chart.append('g');
      var xAxisNode = chart.append('g').attr('transform', `translate(0, ${height})`);

      function update(update_data) {

        var t = d3.transition()
          .duration(750);

        var nestedStateData = d3.nest()
          .key(function (d) { return d.country_txt })
          .rollup(function (leaves) { return leaves.length })
          .entries(update_data)
          .sort(function (a, b) {
            return d3.descending(a.value, b.value);
          }).filter(function (value, index, array) {
            return index <= 10;
          });
        console.log(nestedStateData)
        var maxLength = d3.max(nestedStateData).value;

        yScale.domain([0, maxLength]);
        xScale.domain(nestedStateData.map(function (d) {
          return d.key;
        }));

        yAxisNode.transition(t).call(yAxis);
        xAxisNode.transition(t).call(xAxis);
        xAxisNode.selectAll('text')
          .style('text-anchor', 'start')
          .attr('dx', 10)
          .attr('dy', -5)
          .attr('transform', 'rotate(90)');


        var bars = chart.selectAll('rect').data(nestedStateData);
        var bars_enter = bars.enter().append('rect')
          .attr('x', (d) => xScale(d.key))
          .attr('y', (d) => yScale(d.value))
          .attr('height', (d) => height - yScale(d.value))
          .attr('width', xScale.bandwidth());

        bars.merge(bars).transition(t)
          .attr('x', (d) => xScale(d.key))
          .attr('y', (d) => yScale(d.value))
          .attr('height', (d) => height - yScale(d.value))
          .attr('width', xScale.bandwidth());

        bars.exit().remove();

      }

      return update;
    }

    d3.select('#weapfilter').on('change', function () {
      var selected = d3.select(this).property('value');
      state.weaptype1 = selected;
      updateApp();
    });
  </script>
</body>

</html>