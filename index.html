<!DOCTYPE html>
<html>
<head>
  <title>GTD - BD18</title>
  <meta charset="utf-8">
  <script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script>
  <script src="lib/d3.min.js"></script>
  <style type="text/css">
    body {
      width: 100vw;
      margin: 25px auto;
      font-family: "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
    }
    rect {
      fill: steelblue;
      fill-opacity: 0.8;
    }
    rect:hover {
      fill-opacity: 1;
    }
    path {
      fill-opacity: 0.8;
    }
    .selected,
    path:hover {
      fill-opacity: 1;
    }
    .axis {
      font-size: smaller;
    }
    main {
      display: flex;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <article>
      <header>
        <h1>Global Terrorism Database Analysis</h1>
      </header>
      <p>If there's a microphone anywhere near you, assume it's hot and
      sending whatever you're saying to the world. Seriously.</p>
      <p>...</p>
      <section>
        <h1>Data overview</h1>
        <p>I am a paragraph without any real meaning, maybe next time put just some emoji, little bastard.</p>
        <p><svg id="overview"></svg></p>
      </section>
  </article>
  <script type="text/javascript">

  const state ={
      data: []
      // TODO store selected survived state
    };

  d3.tsv('gtd1417.csv').then((parsed) => {
      state.data = parsed.map((row) => {
        row.eventid = parseInt(row.eventid);
        row.country = parseFloat(row.country);
        return row;
      });

      //console.log(state.data)
      updateApp();
    });

  function updateApp() {
    console.log("Data source fetched")
    createOverviewChart('#overview')
  }

  function createOverviewChart(element_id){
    const margin = {top: 40, bottom: 10, left: 120, right: 20};
    const width = 1200 - margin.left - margin.right;
    const height = 1600 - margin.top - margin.bottom;

    var nestedStateData = d3.nest()
                        .key((d) => d.country_txt)
                        .entries(state.data);

    const scale = d3.scaleBand()
                    .range([0,height])
                    .padding(0.2)
                    .domain(nestedStateData.map(function(d) { 
                      return d.key; 
                      }));
    var maxLength = 0;
    nestedStateData.forEach(element => {
      maxLength = (maxLength<element.values.length)?element.values.length:maxLength;
    });
    console.log(maxLength);
    const xscale = d3.scaleLinear().range([0,width]).domain([0,maxLength]);
    const axis = d3.axisLeft().scale(scale);
    const xaxis = d3.axisTop().scale(xscale);
  
    const g = d3.select(element_id)
                  .attr('width', width+margin.left+margin.right)
                  .attr('height', height+margin.top+margin.bottom)
                  .append('g')
                  .attr('transform', `translate(${margin.left},${margin.top})`)
    const g_axis = g.append('g').attr('transform', 'translate(-10,0)').attr('class','y axis');
    const g_x_axis = g.append('g').attr('transform', 'translate(0,-10)').attr('class','x axis');
    g_axis.call(axis);                  
    g_x_axis.call(xaxis);

    const rect = g.selectAll('rect').data(nestedStateData, (d) => d.key);

    const rect_enter = rect.enter().append('rect').attr('x', 0);
    rect_enter.append('title');

    // ENTER + UPDATE
    // both old and new elements
    console.log(nestedStateData);
    rect.merge(rect_enter)
    .attr('width',(d) => xscale(d.values.length))
    .attr('height',scale.bandwidth())
    .attr('y',(d) => scale(d.key))
    .select('title').text((d) => d.values.length);

    // EXIT
    // elements that aren't associated with data
    rect.exit().remove();
  }
  </script>
</body>
</html>